name: Publish CloudFormation Templates

on:
  workflow_dispatch:
    inputs:
      bucket_name:
        description: 'S3 bucket name for templates'
        required: false
        default: 'memorable-cloudformation-templates'
  push:
    branches:
      - main
    paths:
      - 'cloudformation/**'

env:
  AWS_REGION: us-east-1
  BUCKET_NAME: memorable-cloudformation-templates

# Required for OIDC authentication with AWS
permissions:
  id-token: write
  contents: read

jobs:
  check-aws-config:
    runs-on: ubuntu-latest
    outputs:
      aws_configured: ${{ steps.check.outputs.configured }}
    steps:
      - name: Check AWS configuration
        id: check
        run: |
          if [ -z "${{ secrets.AWS_ACCOUNT_ID }}" ]; then
            echo "AWS_ACCOUNT_ID secret not configured - skipping"
            echo "configured=false" >> $GITHUB_OUTPUT
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

  publish-templates:
    needs: check-aws-config
    if: needs.check-aws-config.outputs.aws_configured == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/memorable-github-actions-memoRable
          role-session-name: github-actions-templates-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate CloudFormation templates
        run: |
          echo "Validating CloudFormation templates..."
          for template in cloudformation/*.yaml; do
            if [[ -f "$template" ]]; then
              echo "  Validating $(basename $template)..."
              aws cloudformation validate-template \
                --template-body "file://${template}" > /dev/null
            fi
          done
          echo "All templates valid!"

      - name: Check if S3 bucket exists
        id: check-bucket
        run: |
          BUCKET="${{ github.event.inputs.bucket_name || env.BUCKET_NAME }}"
          if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            echo "bucket_exists=true" >> $GITHUB_OUTPUT
            echo "Bucket $BUCKET exists"
          else
            echo "bucket_exists=false" >> $GITHUB_OUTPUT
            echo "Bucket $BUCKET does not exist - will create"
          fi

      - name: Create template bucket if needed
        if: steps.check-bucket.outputs.bucket_exists == 'false'
        run: |
          BUCKET="${{ github.event.inputs.bucket_name || env.BUCKET_NAME }}"
          echo "Creating bucket: $BUCKET"

          aws cloudformation deploy \
            --template-file cloudformation/template-bucket.yaml \
            --stack-name memorable-template-bucket \
            --parameter-overrides BucketName=$BUCKET \
            --no-fail-on-empty-changeset

      - name: Publish templates to S3
        run: |
          BUCKET="${{ github.event.inputs.bucket_name || env.BUCKET_NAME }}"
          echo "Publishing templates to s3://$BUCKET"

          for template in cloudformation/*.yaml; do
            if [[ -f "$template" ]]; then
              filename=$(basename "$template")
              echo "  Uploading $filename..."
              aws s3 cp "$template" "s3://$BUCKET/$filename" \
                --content-type "application/x-yaml"
            fi
          done

      - name: Generate deployment summary
        run: |
          BUCKET="${{ github.event.inputs.bucket_name || env.BUCKET_NAME }}"
          BUCKET_URL="https://${BUCKET}.s3.${AWS_REGION}.amazonaws.com"

          echo "## CloudFormation Templates Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Bucket:** \`$BUCKET\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### One-Click Deploy URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Main Stack:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "https://console.aws.amazon.com/cloudformation/home#/stacks/quickcreate?templateUrl=${BUCKET_URL}/memorable-stack.yaml&stackName=memorable" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**GitHub OIDC:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "https://console.aws.amazon.com/cloudformation/home#/stacks/quickcreate?templateUrl=${BUCKET_URL}/github-oidc.yaml&stackName=memorable-github-oidc" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deploy Badges" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[![Deploy to AWS](https://img.shields.io/badge/Deploy%20to-AWS-FF9900?style=for-the-badge&logo=amazon-aws&logoColor=white)](https://console.aws.amazon.com/cloudformation/home#/stacks/quickcreate?templateUrl=${BUCKET_URL}/memorable-stack.yaml&stackName=memorable)" >> $GITHUB_STEP_SUMMARY

  notify-skip:
    needs: check-aws-config
    if: needs.check-aws-config.outputs.aws_configured == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Skip notification
        run: |
          echo "## CloudFormation Templates Not Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "AWS_ACCOUNT_ID secret not configured." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To enable one-click deploy:" >> $GITHUB_STEP_SUMMARY
          echo "1. Add \`AWS_ACCOUNT_ID\` secret to this repository" >> $GITHUB_STEP_SUMMARY
          echo "2. Deploy \`cloudformation/github-oidc.yaml\` to your AWS account" >> $GITHUB_STEP_SUMMARY
          echo "3. Re-run this workflow" >> $GITHUB_STEP_SUMMARY
