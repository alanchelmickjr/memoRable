name: Deploy to AWS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'docker/**'
      - 'cloudformation/**'
      - '.github/workflows/**'
      - 'Dockerfile'
      - 'package.json'
      - 'package-lock.json'

env:
  AWS_REGION: us-west-1
  STACK_NAME: memorable

# Required for OIDC authentication with AWS
permissions:
  id-token: write   # Required for requesting the JWT
  contents: read    # Required for actions/checkout

jobs:
  # Check if AWS credentials are configured
  check-aws-config:
    runs-on: ubuntu-latest
    outputs:
      aws_configured: ${{ steps.check.outputs.configured }}
    steps:
      - name: Check AWS configuration
        id: check
        run: |
          if [ -z "${{ secrets.AWS_ACCOUNT_ID }}" ]; then
            echo "AWS_ACCOUNT_ID secret not configured - skipping deployment"
            echo "configured=false" >> $GITHUB_OUTPUT
          else
            echo "AWS credentials configured"
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: check-aws-config
    if: needs.check-aws-config.outputs.aws_configured == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/memorable-github-actions-memoRable
          role-session-name: github-actions-deploy-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get EC2 instance ID from CloudFormation
        id: get-instance
        run: |
          INSTANCE_ID=$(aws cloudformation describe-stacks \
            --stack-name "${{ env.STACK_NAME }}" \
            --query 'Stacks[0].Outputs[?OutputKey==`InstanceId`].OutputValue' \
            --output text 2>/dev/null || echo "")

          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" = "None" ]; then
            # Fallback: find instance by stack tag
            INSTANCE_ID=$(aws ec2 describe-instances \
              --filters "Name=tag:aws:cloudformation:stack-name,Values=${{ env.STACK_NAME }}" \
                        "Name=instance-state-name,Values=running" \
              --query 'Reservations[0].Instances[0].InstanceId' \
              --output text 2>/dev/null || echo "")
          fi

          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" = "None" ]; then
            echo "Could not find EC2 instance for stack ${{ env.STACK_NAME }}"
            exit 1
          fi

          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Found instance: $INSTANCE_ID"

      - name: Deploy via SSM (git pull + rebuild on EC2)
        id: deploy
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ steps.get-instance.outputs.instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["sudo /opt/memorable/update.sh"]' \
            --timeout-seconds 300 \
            --comment "Deploy from GitHub Actions - ${{ github.sha }}" \
            --query 'Command.CommandId' \
            --output text)

          echo "command_id=$COMMAND_ID" >> $GITHUB_OUTPUT
          echo "SSM Command sent: $COMMAND_ID"

          # Wait for command to complete
          for i in $(seq 1 30); do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ steps.get-instance.outputs.instance_id }}" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            echo "[$i/30] Command status: $STATUS"

            if [ "$STATUS" = "Success" ]; then
              echo "Deploy command completed successfully!"
              break
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "TimedOut" ] || [ "$STATUS" = "Cancelled" ]; then
              echo "Deploy command failed with status: $STATUS"
              # Show output for debugging
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ steps.get-instance.outputs.instance_id }}" \
                --query '[StandardOutputContent, StandardErrorContent]' \
                --output text
              exit 1
            fi

            sleep 10
          done

      - name: Health check
        run: |
          # Get health check URL from CloudFormation stack outputs
          ENDPOINT=$(aws cloudformation describe-stacks --stack-name "${{ env.STACK_NAME }}" \
            --query 'Stacks[0].Outputs[?OutputKey==`HealthCheck`].OutputValue' \
            --output text 2>/dev/null || echo "")
          if [ -z "$ENDPOINT" ]; then
            echo "Could not get endpoint from CloudFormation. Skipping health check."
            exit 0
          fi
          echo "Testing health endpoint at $ENDPOINT..."
          for i in $(seq 1 5); do
            if curl -sf "$ENDPOINT" > /dev/null 2>&1; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i/5 - waiting..."
            sleep 10
          done
          echo "Health check did not pass within timeout - service may still be starting"

  notify:
    needs: [check-aws-config, deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check-aws-config.outputs.aws_configured }}" != "true" ]; then
            echo "**Status:** Deployment skipped (AWS_ACCOUNT_ID not configured)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To enable deployment, add the AWS_ACCOUNT_ID secret to this repository." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "**Status:** Deployment successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Environment:** ${{ github.event.inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
            echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Infrastructure" >> $GITHUB_STEP_SUMMARY
            echo "- Auth: OIDC (no stored credentials)" >> $GITHUB_STEP_SUMMARY
            echo "- IaC: CloudFormation (stack: memorable)" >> $GITHUB_STEP_SUMMARY
            echo "- Deploy: SSM â†’ EC2 git pull + docker rebuild" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** Deployment failed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
